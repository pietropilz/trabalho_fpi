import numpy as np
from PIL import Image
import random

def load_texture(path):
    """Carrega imagem como array NumPy normalizado (0–1)."""
    img = Image.open(path).convert("RGB")
    return np.array(img) / 255.0

def save_image(img_array, path):
    """Salva array NumPy como imagem."""
    img = Image.fromarray((img_array * 255).astype(np.uint8))
    img.save(path)

def image_quilting_basic(texture, out_size=(256, 256), patch_size=64, overlap=16):
    """
    Gera uma nova textura a partir da amostra `texture`.
    texture: np.array (H, W, 3)
    out_size: (altura, largura) da imagem de saída
    patch_size: tamanho dos blocos
    overlap: pixels de sobreposição
    """
    H, W, _ = texture.shape
    out_h, out_w = out_size

    # inicializa saída
    output = np.zeros((out_h, out_w, 3))

    step = patch_size - overlap
    n_patches_y = (out_h - overlap) // step
    n_patches_x = (out_w - overlap) // step

    for i in range(n_patches_y):
        for j in range(n_patches_x):
            # escolhe posição aleatória na textura de entrada
            y = random.randint(0, H - patch_size)
            x = random.randint(0, W - patch_size)
            patch = texture[y:y+patch_size, x:x+patch_size, :]

            y_out = i * step
            x_out = j * step

            # sobreposição: faz blend simples na borda
            region = output[y_out:y_out+patch_size, x_out:x_out+patch_size, :]
            mask = np.zeros_like(patch)
            mask[:] = 1.0

            if i > 0:
                alpha_y = np.linspace(0, 1, overlap).reshape(-1, 1, 1)
                mask[:overlap, :, :] = alpha_y
            if j > 0:
                alpha_x = np.linspace(0, 1, overlap).reshape(1, -1, 1)
                mask[:, :overlap, :] = alpha_x

            region = region * (1 - mask) + patch * mask
            output[y_out:y_out+patch_size, x_out:x_out+patch_size, :] = region

    return output


texture = load_texture("frutas_draw.jpg")
result = image_quilting_basic(texture, out_size=(1024, 1024), patch_size=64, overlap=16)
save_image(result, "resultado_quilting.jpg")
